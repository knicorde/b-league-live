<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>Bリーグ実況ビューア</title>

  <style>
    :root{
      --bg:#0b0d12;
      --panel:#111523;
      --panel2:#0f1320;
      --card:#171c2e;
      --text:#e8ecff;
      --text-muted:#aab1d6;
      --line:rgba(255,255,255,.10);
      --line2:rgba(0,0,0,.25);
      --good:#19c37d;
      --bad:#ff4d4f;
      --warn:#ffcc00;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(180deg,#070812 0%, #0b0d12 70%);
      color:var(--text);
    }
    a{color:inherit}
    .topbar{
      position:sticky; top:0; z-index:5;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:10px 12px;
      background:rgba(10,12,18,.9);
      backdrop-filter:saturate(160%) blur(10px);
      border-bottom:1px solid var(--line);
    }
    .brand{font-weight:800; letter-spacing:.02em}
    .ctrl{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      margin-left:auto;
    }
    .btn{
      appearance:none; border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .file{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px dashed var(--line);
      border-radius:12px;
      background:rgba(255,255,255,.04);
      font-size:12px;
    }
    .file input{display:none}
    .badge{
      display:none;
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text-muted);
    }
    .badge.on{display:inline-block}

    .error{
      display:none;
      padding:10px 12px;
      background:rgba(255,77,79,.14);
      border-bottom:1px solid rgba(255,77,79,.35);
      color:#ffd7d7;
      font-size:13px;
      white-space:pre-wrap;
    }
    .error.on{display:block}

    .wrap{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:12px;
      padding:12px;
      max-width:1200px;
      margin:0 auto;
    }
    @media (max-width: 900px){
      .wrap{grid-template-columns: 1fr}
    }
    .pane{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.04);
      overflow:hidden;
    }
    .pane-inner{padding:12px}

    /* left */
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .tab{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text-muted);
      font-size:12px;
      cursor:pointer;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .tab.on{
      background:rgba(25,195,125,.12);
      border-color:rgba(25,195,125,.35);
      color:var(--text);
    }
    .search{
      display:flex; gap:8px;
      margin-bottom:10px;
    }
    .search input{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height: calc(100vh - 240px);
      overflow:auto;
      padding-right:4px;
    }
    .pbtn{
      display:flex; align-items:center; gap:10px;
      text-align:left;
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
    }
    .pbtn.selected{
      border-color:rgba(25,195,125,.35);
      background:rgba(25,195,125,.10);
    }
    .jersey{
      width:44px;
      font-weight:800;
      color:var(--text-muted);
      font-variant-numeric:tabular-nums;
    }
    .pname{
      flex:1;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-size:14px;
    }

    /* flow summary */
    .flow-summary{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      margin-bottom:10px;
      background:rgba(0,0,0,.14);
    }
    .flow-title{font-weight:800;font-size:13px;margin-bottom:6px;}
    .flow-sub{font-size:12px;color:var(--text-muted);line-height:1.35;}
    .flow-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
    .chip{
      font-size:12px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--text);
      font-variant-numeric:tabular-nums;
    }
    .chip.pos{border-color:rgba(25,195,125,.35)}
    .chip.neg{border-color:rgba(255,77,79,.35)}
    .flow-grid{display:grid;grid-template-columns:1fr;gap:6px;margin-top:8px;}
    .flow-item{display:flex;justify-content:space-between;gap:10px;font-size:12px;}
    .flow-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    .flow-val{color:var(--text-muted);font-variant-numeric:tabular-nums;}

    /* right */
    .empty{
      color:var(--text-muted);
      font-size:14px;
      padding:20px;
      text-align:center;
    }
    .ph{
      display:flex; align-items:baseline; gap:10px;
      margin-bottom:10px;
    }
    .ph .num{font-weight:900; color:var(--text-muted)}
    .ph .name{font-weight:900; font-size:20px}
    .section{margin-top:14px}
    .section-title{
      font-weight:800;
      font-size:12px;
      letter-spacing:.06em;
      color:var(--text-muted);
      text-transform:uppercase;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .big3{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 900px){
      .big3{grid-template-columns: 1fr}
    }
    .card{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:rgba(255,255,255,.03);
    }
    .val{font-size:28px;font-weight:900;font-variant-numeric:tabular-nums;line-height:1}
    .lab{font-size:12px;color:var(--text-muted);margin-top:6px}
    .delta{margin-top:8px;font-size:12px;font-variant-numeric:tabular-nums}
    .delta.pos{color:var(--good)}
    .delta.neg{color:var(--bad)}

    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .minchip{color:var(--text-muted)}
    .sh-grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    @media (max-width: 900px){
      .sh-grid{grid-template-columns:1fr}
    }
    .sh-card{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.02);
    }
    .sh-head{display:flex;justify-content:space-between;gap:10px}
    .sh-cat{font-weight:800;font-size:12px;color:var(--text-muted)}
    .sh-val{font-weight:900;font-variant-numeric:tabular-nums}
    .sh-meta{font-size:12px;color:var(--text-muted);margin-top:6px;line-height:1.3}

    .memo{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:rgba(0,0,0,.14);
    }
    .memo-text{font-size:14px;line-height:1.4;white-space:pre-wrap}
    .memo-empty{color:var(--text-muted);font-size:13px}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">Bリーグ実況ビューア</div>

    <div class="ctrl">
      <label class="file btn">
        bundle.json 読込
        <input id="file-bundle" type="file" accept="application/json" />
      </label>

      <label class="file btn">
        team_avg.json 読込
        <input id="file-avg" type="file" accept="application/json" />
      </label>

      <span id="badge-bundle" class="badge">bundle: loaded</span>
      <span id="badge-avg" class="badge">avg: loaded</span>

      <button id="btn-clear" class="btn" type="button">保存をクリア</button>
    </div>
  </div>

  <div id="error" class="error"></div>

  <div class="wrap">
    <div class="pane" id="left">
      <div class="pane-inner">
        <div id="flow-summary" class="flow-summary"></div>

        <div class="tabs" id="team-tabs"></div>

        <div class="search">
          <input id="search-input" type="text" placeholder="選手検索（2文字以上 / 背番号もOK）" />
        </div>

        <div class="list" id="player-list"></div>
      </div>
    </div>

    <div class="pane" id="right">
      <div class="pane-inner" id="right-pane">
        <div class="empty">bundle.json を読み込むと表示されます</div>
      </div>
    </div>
  </div>

  <script>
    // ─────────────────────────────────────────────
    // Storage keys
    // ─────────────────────────────────────────────
    const LS_KEY_BUNDLE = 'basketball_bundle_v1';
    const LS_KEY_AVG    = 'basketball_teamavg_v1';
    const LS_KEY_TEAM   = 'basketball_team_key_v1';
    const LS_KEY_NOTES  = 'basketball_notes_v1';

    // ─────────────────────────────────────────────
    // State
    // ─────────────────────────────────────────────
    let bundle = null;
    let teamAvg = null;
    let currentTeamKey = '';
    let selectedPlayer = null;
    let notesData = {}; // { memoKey: text }

    // ─────────────────────────────────────────────
    // Utils
    // ─────────────────────────────────────────────
    function esc(s){
      return String(s ?? '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }
    function nfkc(s){
      try { return (s ?? '').toString().normalize('NFKC').trim(); }
      catch(e){ return (s ?? '').toString().trim(); }
    }
    function showError(msg){
      const el = document.getElementById('error');
      el.textContent = msg;
      el.classList.add('on');
    }
    function hideError(){
      const el = document.getElementById('error');
      el.textContent = '';
      el.classList.remove('on');
    }
    function setBadge(id, on){
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle('on', !!on);
    }
    function fmt1(x){
      const n = Number(x);
      if (Number.isNaN(n)) return '—';
      return Math.round(n * 10) / 10;
    }
    function minToDisplay(minFloat){
      const n = Number(minFloat);
      if (Number.isNaN(n)) return '—';
      const total = Math.round(n * 60);
      const m = Math.floor(total / 60);
      const s = total % 60;
      return `${m}:${String(s).padStart(2,'0')}`;
    }

    function readJSON(file, cb){
      const reader = new FileReader();
      reader.onload = e => {
        try { cb(JSON.parse(e.target.result), null); }
        catch(err){ cb(null, err.message || String(err)); }
      };
      reader.onerror = () => cb(null, 'ファイルの読み込みに失敗しました');
      reader.readAsText(file);
    }

    // ─────────────────────────────────────────────
    // Data accessors
    // ─────────────────────────────────────────────
    function teamKeys(){
      if (!bundle?.teams) return [];
      return Object.keys(bundle.teams);
    }
    function ensureCurrentTeam(){
      const keys = teamKeys();
      if (!keys.length) return '';
      if (currentTeamKey && bundle.teams[currentTeamKey]) return currentTeamKey;

      // try saved
      let saved = '';
      try { saved = localStorage.getItem(LS_KEY_TEAM) || ''; } catch(e){}
      if (saved && bundle.teams[saved]) {
        currentTeamKey = saved;
        return currentTeamKey;
      }
      currentTeamKey = keys[0] || '';
      return currentTeamKey;
    }
    function getPlayers(teamKey){
      if (!bundle?.teams?.[teamKey]) return [];
      const arr = (bundle.teams[teamKey].players || []).slice();
      arr.sort((a,b) => (parseInt(a.jersey_number,10) || 0) - (parseInt(b.jersey_number,10) || 0));
      return arr;
    }
    function getAvgForTeam(teamName){
      if (!teamAvg || typeof teamAvg !== 'object') return null;

      // most common: { "シーホース三河": {PTS:..} , ... }
      if (teamAvg[teamName]) return teamAvg[teamName];

      // fallback: NFKC compare
      const tn = nfkc(teamName);
      for (const k of Object.keys(teamAvg)){
        if (nfkc(k) === tn) return teamAvg[k];
      }
      return null;
    }
    function memoKeyForPlayer(p){
      const id = nfkc(p?.team_jba_id);
      if (id) return id;
      // fallback key: team + jersey
      return `${nfkc(currentTeamKey)}#${nfkc(p?.jersey_number)}`;
    }

    // ─────────────────────────────────────────────
    // Flow summary (auto, no input)
    // ─────────────────────────────────────────────
    function renderFlowSummary(){
      const box = document.getElementById('flow-summary');
      if (!box) return;

      if (!bundle?.teams){
        box.innerHTML = `
          <div class="flow-title">流れサマリー（自動）</div>
          <div class="flow-sub">bundle.json 未読み込み</div>
        `;
        return;
      }

      const tkey = ensureCurrentTeam();
      const players = getPlayers(tkey);
      const avg = getAvgForTeam(tkey);

      const LABEL = { PTS:'得点', REB:'REB', AST:'AST', '3PM':'3P', STL:'STL', BLK:'BLK', MIN:'MIN' };
      const STATS = ['PTS','REB','AST','3PM','STL','BLK','MIN'];

      function scoreOf(p){
        if (!avg) return 0;
        const s = p.stats || {};
        let sc = 0;
        sc += (Number(s.PTS||0) - Number(avg.PTS||0)) * 1.0;
        sc += (Number(s.REB||0) - Number(avg.REB||0)) * 0.9;
        sc += (Number(s.AST||0) - Number(avg.AST||0)) * 0.9;
        sc += (Number(s['3PM']||0) - Number(avg['3PM']||0)) * 0.8;
        sc += (Number(s.STL||0) - Number(avg.STL||0)) * 0.6;
        sc += (Number(s.BLK||0) - Number(avg.BLK||0)) * 0.6;
        sc += (Number(s.MIN||0) - Number(avg.MIN||0)) * 0.15;
        return Math.round(sc * 10) / 10;
      }
      function teamDelta(stat){
        if (!avg) return null;
        const deltas = players.map(p => Number((p.stats||{})[stat] || 0) - Number(avg[stat] || 0));
        const m = deltas.reduce((x,y)=>x+y,0) / (deltas.length || 1);
        return Math.round(m * 10) / 10;
      }

      const scored = players.map(p => ({p, sc: scoreOf(p)})).sort((a,b)=>b.sc-a.sc);
      const topPos = scored.slice(0,3);
      const topNeg = scored.slice().reverse().slice(0,3);

      let trend = [];
      if (avg){
        trend = STATS.map(st => ({st, d: teamDelta(st)}))
          .filter(x => x.d !== null)
          .sort((a,b)=>Math.abs(b.d)-Math.abs(a.d))
          .slice(0,3);
      }

      const trendHTML = avg ? `
        <div class="flow-row">
          ${trend.map(x=>{
            const cls = x.d >= 0 ? 'pos' : 'neg';
            const sign = x.d > 0 ? '+' : '';
            return `<span class="chip ${cls}">${LABEL[x.st]} Δ${sign}${x.d}</span>`;
          }).join('')}
        </div>
      ` : `<div class="flow-sub" style="margin-top:8px;">team_avg.json を読むと「チーム傾向（Δ）」が出ます</div>`;

      function itemHTML(x){
        const name = nfkc(x.p?.player_name);
        const cls = x.sc >= 0 ? 'pos' : 'neg';
        const sign = x.sc > 0 ? '+' : '';
        return `
          <div class="flow-item">
            <div class="flow-name">${esc(name)}</div>
            <div class="flow-val"><span class="${cls}">総合Δ ${sign}${x.sc}</span></div>
          </div>
        `;
      }

      box.innerHTML = `
        <div class="flow-title">流れサマリー（自動）</div>
        <div class="flow-sub">${esc(tkey)}：平均比の上振れ/下振れ（入力なし）</div>
        ${trendHTML}
        <div class="flow-grid">
          <div class="flow-sub" style="margin-top:8px;">上振れ（平均より良い）</div>
          ${topPos.map(itemHTML).join('') || '<div class="flow-sub">—</div>'}
          <div class="flow-sub" style="margin-top:10px;">下振れ（平均より苦しい）</div>
          ${topNeg.map(itemHTML).join('') || '<div class="flow-sub">—</div>'}
        </div>
      `;
    }

    // ─────────────────────────────────────────────
    // Rendering
    // ─────────────────────────────────────────────
    function renderTabs(){
      const el = document.getElementById('team-tabs');
      el.innerHTML = '';
      if (!bundle?.teams) return;
      const keys = teamKeys();
      const cur = ensureCurrentTeam();

      keys.forEach(k => {
        const b = document.createElement('button');
        b.className = 'tab' + (k === cur ? ' on' : '');
        b.textContent = k;
        b.onclick = () => {
          currentTeamKey = k;
          try { localStorage.setItem(LS_KEY_TEAM, currentTeamKey); } catch(e){}
          selectedPlayer = null;
          renderTabs();
          window.filterPlayers();
          showEmptyRight();
        };
        el.appendChild(b);
      });
    }

    function showEmptyRight(){
      const rp = document.getElementById('right-pane');
      rp.innerHTML = `<div class="empty">左の一覧から選手をタップ</div>`;
    }

    function deltaHTML(v, a){
      const d = Math.round((Number(v||0) - Number(a||0)) * 10) / 10;
      const cls = d >= 0 ? 'pos' : 'neg';
      const sign = d > 0 ? '+' : '';
      return `<div class="delta ${cls}">Δ ${sign}${d}</div>`;
    }

    function renderPlayerDetail(p){
      selectedPlayer = p;

      const rp = document.getElementById('right-pane');
      const s  = p?.stats || {};
      const sh = p?.season_high || {};
      const avg = getAvgForTeam(ensureCurrentTeam());

      const memoKey = memoKeyForPlayer(p);
      const memoText = (notesData && memoKey in notesData) ? String(notesData[memoKey] ?? '') : '';

      // season high cards
      const LABEL = { PTS:'得点', REB:'REB', AST:'AST', '3PM':'3P', STL:'STL', BLK:'BLK', MIN:'MIN' };
      const order = ['PTS','REB','AST','3PM','STL','BLK','MIN'];
      let shHTML = '';
      order.forEach(k=>{
        const it = sh[k];
        if (!it) return;
        const val = (it.display ?? it.value ?? '—');
        const meta = [it.date, it.opponent].filter(Boolean).join(' vs ');
        shHTML += `
          <div class="sh-card">
            <div class="sh-head">
              <div class="sh-cat">${esc(LABEL[k] || k)}</div>
              <div class="sh-val">${esc(String(val))}</div>
            </div>
            ${meta ? `<div class="sh-meta">${esc(meta)}</div>` : `<div class="sh-meta">—</div>`}
          </div>
        `;
      });

      rp.innerHTML = `
        <div class="ph">
          <div class="num">#${esc(p.jersey_number)}</div>
          <div class="name">${esc(p.player_name)}</div>
        </div>

        <div class="section">
          <div class="section-title">
            <span>今日のスタッツ ${avg ? '<span style="font-weight:400; text-transform:none; letter-spacing:0">（Δ = 選手 − チーム平均）</span>' : ''}</span>
          </div>

          <div class="big3">
            <div class="card">
              <div class="val">${fmt1(s.PTS)}</div>
              <div class="lab">PTS</div>
              ${avg ? deltaHTML(s.PTS, avg.PTS) : ''}
            </div>
            <div class="card">
              <div class="val">${fmt1(s.REB)}</div>
              <div class="lab">REB</div>
              ${avg ? deltaHTML(s.REB, avg.REB) : ''}
            </div>
            <div class="card">
              <div class="val">${fmt1(s.AST)}</div>
              <div class="lab">AST</div>
              ${avg ? deltaHTML(s.AST, avg.AST) : ''}
            </div>
          </div>

          <div class="chips">
            <span class="chip">${esc('3PM')} ${fmt1(s['3PM'])}${avg ? ` <span style="opacity:.8">Δ${(Math.round(((Number(s['3PM']||0)-Number(avg['3PM']||0))*10))/10>=0?'+':'')}${Math.round((Number(s['3PM']||0)-Number(avg['3PM']||0))*10)/10}</span>` : ''}</span>
            <span class="chip">${esc('STL')} ${fmt1(s.STL)}${avg ? ` <span style="opacity:.8">Δ${(Math.round(((Number(s.STL||0)-Number(avg.STL||0))*10))/10>=0?'+':'')}${Math.round((Number(s.STL||0)-Number(avg.STL||0))*10)/10}</span>` : ''}</span>
            <span class="chip">${esc('BLK')} ${fmt1(s.BLK)}${avg ? ` <span style="opacity:.8">Δ${(Math.round(((Number(s.BLK||0)-Number(avg.BLK||0))*10))/10>=0?'+':'')}${Math.round((Number(s.BLK||0)-Number(avg.BLK||0))*10)/10}</span>` : ''}</span>
            <span class="chip minchip">MIN ${esc(s.MIN_display || minToDisplay(s.MIN))}${avg ? ` <span style="opacity:.8">Δ${(Math.round(((Number(s.MIN||0)-Number(avg.MIN||0))*10))/10>=0?'+':'')}${Math.round((Number(s.MIN||0)-Number(avg.MIN||0))*10)/10}</span>` : ''}</span>
          </div>
        </div>

        <div class="section">
          <div class="section-title">
            <span>メモ</span>
            <button class="btn" type="button" onclick="window.memoEdit()">編集</button>
          </div>
          <div class="memo">
            ${memoText ? `<div class="memo-text">${esc(memoText)}</div>` : `<div class="memo-empty">（未入力）</div>`}
          </div>
        </div>

        <div class="section">
          <div class="section-title"><span>シーズンハイ</span></div>
          <div class="sh-grid">
            ${shHTML || '<div class="empty">データなし</div>'}
          </div>
        </div>
      `;
    }

    // ─────────────────────────────────────────────
    // Player list (filter + render)
    // ─────────────────────────────────────────────
    window.filterPlayers = function(){
      if (!bundle?.teams) return;

      const tkey = ensureCurrentTeam();
      const q = nfkc(document.getElementById('search-input')?.value || '');
      const all = getPlayers(tkey);

      const filtered = (q.length >= 2)
        ? all.filter(p => nfkc(p.player_name).includes(q) || nfkc(p.jersey_number).includes(q))
        : all;

      // update flow summary every time
      renderFlowSummary();

      const list = document.getElementById('player-list');
      list.innerHTML = '';

      filtered.forEach(p=>{
        const b = document.createElement('button');
        const isSel = selectedPlayer && memoKeyForPlayer(selectedPlayer) === memoKeyForPlayer(p);
        b.className = 'pbtn' + (isSel ? ' selected' : '');
        b.innerHTML = `<div class="jersey">#${esc(p.jersey_number)}</div><div class="pname">${esc(p.player_name)}</div>`;
        b.onclick = ()=>{
          document.querySelectorAll('.pbtn').forEach(x=>x.classList.remove('selected'));
          b.classList.add('selected');
          renderPlayerDetail(p);
        };
        list.appendChild(b);
      });
    };

    // ─────────────────────────────────────────────
    // Memo
    // ─────────────────────────────────────────────
    window.memoEdit = function(){
      if (!selectedPlayer) return;
      const key = memoKeyForPlayer(selectedPlayer);
      const cur = (notesData && key in notesData) ? String(notesData[key] ?? '') : '';
      const next = prompt('メモ（保存されます）', cur);
      if (next === null) return;

      notesData = notesData || {};
      notesData[key] = String(next);

      try { localStorage.setItem(LS_KEY_NOTES, JSON.stringify(notesData)); } catch(e){}
      renderPlayerDetail(selectedPlayer);
    };

    // ─────────────────────────────────────────────
    // Loaders
    // ─────────────────────────────────────────────
    function loadBundle(data, save){
      if (!data?.teams) throw new Error('"teams" フィールドがありません');
      bundle = data;

      ensureCurrentTeam();

      if (save){
        try { localStorage.setItem(LS_KEY_BUNDLE, JSON.stringify(data)); } catch(e){}
        try { localStorage.setItem(LS_KEY_TEAM, currentTeamKey); } catch(e){}
      }

      setBadge('badge-bundle', true);
      renderTabs();
      window.filterPlayers();
      showEmptyRight();
    }

    function loadAvg(data, save){
      if (!data || typeof data !== 'object' || Array.isArray(data)){
        throw new Error('team_avg.json の形式が正しくありません（オブジェクトが必要です）');
      }
      teamAvg = data;
      if (save){
        try { localStorage.setItem(LS_KEY_AVG, JSON.stringify(data)); } catch(e){}
      }
      setBadge('badge-avg', true);

      // rerender
      renderFlowSummary();
      if (selectedPlayer) renderPlayerDetail(selectedPlayer);
    }

    // ─────────────────────────────────────────────
    // UI events
    // ─────────────────────────────────────────────
    document.getElementById('file-bundle').addEventListener('change', (event)=>{
      const file = event.target.files?.[0];
      if (!file) return;
      readJSON(file, (data, err)=>{
        if (err){ showError('bundle.json のパースに失敗しました:\n' + err); return; }
        try { loadBundle(data, true); hideError(); }
        catch(e2){ showError('bundle.json の読み込みエラー:\n' + (e2.message || e2)); }
      });
      event.target.value = '';
    });

    document.getElementById('file-avg').addEventListener('change', (event)=>{
      const file = event.target.files?.[0];
      if (!file) return;
      readJSON(file, (data, err)=>{
        if (err){ showError('team_avg.json のパースに失敗しました:\n' + err); return; }
        try { loadAvg(data, true); hideError(); }
        catch(e2){ showError('team_avg.json の読み込みエラー:\n' + (e2.message || e2)); }
      });
      event.target.value = '';
    });

    document.getElementById('search-input').addEventListener('input', ()=>{
      if (bundle?.teams) window.filterPlayers();
    });

    document.getElementById('btn-clear').addEventListener('click', ()=>{
      const ok = confirm('保存データ（bundle/team_avg/メモ）を削除します。よろしいですか？');
      if (!ok) return;
      try {
        localStorage.removeItem(LS_KEY_BUNDLE);
        localStorage.removeItem(LS_KEY_AVG);
        localStorage.removeItem(LS_KEY_TEAM);
        localStorage.removeItem(LS_KEY_NOTES);
      } catch(e){}
      bundle = null; teamAvg = null; currentTeamKey = ''; selectedPlayer = null; notesData = {};
      setBadge('badge-bundle', false);
      setBadge('badge-avg', false);
      document.getElementById('team-tabs').innerHTML = '';
      document.getElementById('player-list').innerHTML = '';
      document.getElementById('flow-summary').innerHTML = `
        <div class="flow-title">流れサマリー（自動）</div>
        <div class="flow-sub">bundle.json 未読み込み</div>
      `;
      document.getElementById('right-pane').innerHTML = `<div class="empty">bundle.json を読み込むと表示されます</div>`;
      hideError();
    });

    // ─────────────────────────────────────────────
    // Boot restore
    // ─────────────────────────────────────────────
    (function boot(){
      // notes
      try {
        const s = localStorage.getItem(LS_KEY_NOTES);
        if (s) notesData = JSON.parse(s) || {};
      } catch(e){ notesData = {}; }

      // avg
      try {
        const s = localStorage.getItem(LS_KEY_AVG);
        if (s) { teamAvg = JSON.parse(s); setBadge('badge-avg', true); }
      } catch(e){}

      // bundle
      try {
        const s = localStorage.getItem(LS_KEY_BUNDLE);
        if (s) {
          const data = JSON.parse(s);
          loadBundle(data, false);
        } else {
          setBadge('badge-bundle', false);
          renderFlowSummary();
        }
      } catch(e){
        showError('保存データの読み込みに失敗しました:\n' + (e.message || e));
        setBadge('badge-bundle', false);
        renderFlowSummary();
      }

      // if bundle exists, refresh flow summary
      if (bundle?.teams){
        renderFlowSummary();
      }
    })();
  </script>
</body>
</html>
